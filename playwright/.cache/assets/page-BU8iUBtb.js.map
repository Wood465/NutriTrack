{"version":3,"file":"page-BU8iUBtb.js","sources":["../../../app/profile/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport Link from 'next/link';\r\nimport Navbar from '@/app/ui/navbar';\r\n\r\n/**\r\n * PROFILE PAGE (Profil)\r\n *\r\n * Namen strani:\r\n * - Prikaze osnovne podatke o prijavljenem uporabniku (ime, priimek, email).\r\n * - Omogoca nalaganje profilne slike (avatar).\r\n * - Izracuna osnovno statistiko iz obrokov:\r\n *   - povprecen dnevni vnos kalorij\r\n *   - stevilo dni, ko je uporabnik kaj zabelezil\r\n *\r\n * Kako deluje:\r\n * 1) Ob nalaganju strani preberemo sejo (/api/session) -> dobimo uporabnika.\r\n * 2) Ko uporabnika poznamo, nalozimo njegove obroke (/api/meals?user_id=...).\r\n * 3) Iz obrokov izracunamo:\r\n *    - total kalorij\r\n *    - koliko razlicnih dni je zabelezenih\r\n *    - average = total / st. dni\r\n * 4) Avatar nalagamo na /api/profile/avatar (POST z FormData).\r\n *    Za prikaz avatarja uporabljamo /api/profile/avatar/view.\r\n *    \"avatarKey\" je samo trik za osvezevanje slike (da browser ne uporabi cache-a).\r\n */\r\n\r\nexport default function ProfilePage() {\r\n  /**\r\n   * Avatar:\r\n   * - avatarSrc: URL slike, ki jo prikazemo v <img>\r\n   * - avatarKey: vrednost, ki se spremeni po uploadu in prisili reload slike\r\n   * - defaultAvatarSrc: fallback, ce avatar endpoint vrne napako (npr. ni slike)\r\n   */\r\n  const [avatarKey, setAvatarKey] = useState(0);\r\n  const [avatarSrc, setAvatarSrc] = useState(`/api/profile/avatar/view?key=0`);\r\n  const defaultAvatarSrc = '/avatar-default.svg';\r\n\r\n  // user: trenutno prijavljen uporabnik (za izpis podatkov + user.id)\r\n  const [user, setUser] = useState<any>(null);\r\n\r\n  // statistika: povprecje kalorij in stevilo dni z vnosom\r\n  const [averageCalories, setAverageCalories] = useState<number | null>(null);\r\n  const [loggedDays, setLoggedDays] = useState<number | null>(null);\r\n\r\n  /**\r\n   * 1) Nalozimo prijavljenega uporabnika iz seje\r\n   * - /api/session vrne { user: ... } ali null\r\n   */\r\n  useEffect(() => {\r\n    async function loadUser() {\r\n      const res = await fetch('/api/session', { cache: 'no-store' });\r\n      const data = await res.json();\r\n      setUser(data.user);\r\n    }\r\n\r\n    loadUser();\r\n  }, []);\r\n\r\n  /**\r\n   * 2) Ko imamo user, nalozimo njegove obroke in izracunamo statistiko\r\n   * - ce ni obrokov: statistiko nastavimo na 0\r\n   * - days: uporabimo Set, da dobimo stevilo unikatnih datumov (YYYY-MM-DD)\r\n   */\r\n  useEffect(() => {\r\n    if (!user) return;\r\n\r\n    async function loadStats() {\r\n      const res = await fetch(`/api/meals?user_id=${user.id}`, {\r\n        cache: 'no-store',\r\n      });\r\n\r\n      const meals = await res.json();\r\n\r\n      if (meals.length === 0) {\r\n        setAverageCalories(0);\r\n        setLoggedDays(0);\r\n        return;\r\n      }\r\n\r\n      // vsota kalorij vseh obrokov\r\n      const totalCalories = meals.reduce(\r\n        (sum: number, meal: any) => sum + parseFloat(meal.kalorije || 0),\r\n        0,\r\n      );\r\n\r\n      // unikatni dnevi (YYYY-MM-DD) -> koliko dni je bilo sploh kaj zabelezeno\r\n      const uniqueDays = new Set(\r\n        meals.map((m: any) => new Date(m.cas).toISOString().slice(0, 10)),\r\n      );\r\n\r\n      setLoggedDays(uniqueDays.size);\r\n      setAverageCalories(Math.round(totalCalories / uniqueDays.size));\r\n    }\r\n\r\n    loadStats();\r\n  }, [user]);\r\n\r\n  /**\r\n   * 3) Posodobitev avatar URL-ja, ko se spremeni avatarKey\r\n   * - key dodamo v query, da se URL spremeni in browser ponovno nalozi sliko\r\n   */\r\n  useEffect(() => {\r\n    setAvatarSrc(`/api/profile/avatar/view?key=${avatarKey}`);\r\n  }, [avatarKey]);\r\n\r\n  /**\r\n   * 4) Upload avatarja\r\n   * - uporabimo FormData, ker posiljamo datoteko (image/*)\r\n   * - ce uspe: spremenimo avatarKey -> prisilimo reload prikaza\r\n   */\r\n  async function uploadAvatar(e: React.ChangeEvent<HTMLInputElement>) {\r\n    const file = e.target.files?.[0];\r\n    if (!file) return;\r\n\r\n    const formData = new FormData();\r\n    formData.append('avatar', file);\r\n\r\n    const res = await fetch('/api/profile/avatar', {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    if (res.ok) {\r\n      // Date.now() zagotovi nov key -> nov URL -> nova slika brez cache-a\r\n      setAvatarKey(Date.now());\r\n    } else {\r\n      alert('Upload ni uspel');\r\n    }\r\n  }\r\n\r\n  return (\r\n    <main className=\"min-h-screen\">\r\n      {/* Navigacija */}\r\n      <Navbar />\r\n\r\n      <div className=\"mx-auto max-w-6xl space-y-10 px-4 pb-16 pt-10 md:px-6\">\r\n        {/* Hero / naslov strani */}\r\n        <section className=\"rounded-3xl border border-blue-200/50 bg-gradient-to-br from-blue-600 via-blue-500 to-sky-500 p-8 text-white shadow-lg md:p-12\">\r\n          <div className=\"max-w-3xl space-y-3\">\r\n            <p className=\"text-sm font-semibold uppercase tracking-wide text-blue-100\">\r\n              Profil\r\n            </p>\r\n            <h1 className=\"text-3xl font-semibold md:text-4xl\">Tvoj racun</h1>\r\n            <p className=\"text-base text-blue-100 md:text-lg\">\r\n              Uredi podatke in spremljaj povprecje vnosa.\r\n            </p>\r\n          </div>\r\n        </section>\r\n\r\n        {/* Layout: levo osebni podatki, desno statistika */}\r\n        <section className=\"grid gap-6 lg:grid-cols-[1.2fr_0.8fr]\">\r\n          {/* LEVO: uporabnikovi podatki + avatar */}\r\n          <div className=\"rounded-3xl border border-gray-200/70 bg-white/95 p-6 shadow-sm backdrop-blur dark:border-gray-800/70 dark:bg-gray-900/80 md:p-8\">\r\n            <h2 className=\"text-xl font-semibold text-gray-900 dark:text-gray-100\">\r\n              Osebni podatki\r\n            </h2>\r\n\r\n            {/* Prikaz podatkov iz seje (ce user ni nalozen, izpisemo '--') */}\r\n            <div className=\"mt-5 space-y-2 text-sm text-gray-700 dark:text-gray-300\">\r\n              <p>\r\n                <span className=\"font-medium text-gray-900 dark:text-gray-100\">\r\n                  Ime:\r\n                </span>{' '}\r\n                {user?.ime ?? '--'}\r\n              </p>\r\n              <p>\r\n                <span className=\"font-medium text-gray-900 dark:text-gray-100\">\r\n                  Priimek:\r\n                </span>{' '}\r\n                {user?.priimek ?? '--'}\r\n              </p>\r\n              <p>\r\n                <span className=\"font-medium text-gray-900 dark:text-gray-100\">\r\n                  E-posta:\r\n                </span>{' '}\r\n                {user?.email ?? '--'}\r\n              </p>\r\n            </div>\r\n\r\n            {/* Avatar + akcije */}\r\n            <div className=\"mt-6 flex flex-wrap items-center gap-4\">\r\n              <img\r\n                src={avatarSrc}\r\n                alt=\"Profilna slika\"\r\n                className=\"h-20 w-20 rounded-full border border-gray-200 object-cover dark:border-gray-800\"\r\n                onError={() => {\r\n                  // Ce avatar endpoint odpove, preklopimo na default sliko\r\n                  if (avatarSrc !== defaultAvatarSrc) {\r\n                    setAvatarSrc(defaultAvatarSrc);\r\n                  }\r\n                }}\r\n              />\r\n\r\n              {/* Upload polje je skrito, kliknemo label kot gumb */}\r\n              <label className=\"cursor-pointer rounded-full border border-blue-200 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-blue-700 transition hover:bg-blue-50 dark:border-blue-900/40 dark:text-blue-200 dark:hover:bg-blue-950/40\">\r\n                Spremeni sliko\r\n                <input\r\n                  type=\"file\"\r\n                  name=\"avatar\"\r\n                  accept=\"image/*\"\r\n                  className=\"hidden\"\r\n                  onChange={uploadAvatar}\r\n                />\r\n              </label>\r\n\r\n              {/* Link do strani za spremembo gesla */}\r\n              <Link\r\n                href=\"/profile/change-password\"\r\n                className=\"rounded-full border border-gray-200 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-gray-700 transition hover:bg-gray-100 dark:border-gray-800 dark:text-gray-200 dark:hover:bg-gray-800\"\r\n              >\r\n                Spremeni geslo\r\n              </Link>\r\n            </div>\r\n          </div>\r\n\r\n          {/* DESNO: statistika iz obrokov */}\r\n          <div className=\"rounded-3xl border border-gray-200/70 bg-white/95 p-6 shadow-sm backdrop-blur dark:border-gray-800/70 dark:bg-gray-900/80 md:p-8\">\r\n            <h2 className=\"text-xl font-semibold text-gray-900 dark:text-gray-100\">\r\n              Statistika\r\n            </h2>\r\n\r\n            <div className=\"mt-6 space-y-4\">\r\n              <div className=\"rounded-2xl border border-gray-200/70 bg-white/95 p-4 shadow-sm dark:border-gray-800/70 dark:bg-gray-900/80\">\r\n                <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400\">\r\n                  Povprecen dnevni vnos\r\n                </p>\r\n                <p className=\"mt-2 text-2xl font-semibold text-gray-900 dark:text-gray-100\">\r\n                  {averageCalories !== null\r\n                    ? `${averageCalories} kcal`\r\n                    : 'Nalaganje...'}\r\n                </p>\r\n              </div>\r\n\r\n              <div className=\"rounded-2xl border border-gray-200/70 bg-white/95 p-4 shadow-sm dark:border-gray-800/70 dark:bg-gray-900/80\">\r\n                <p className=\"text-xs font-semibold uppercase tracking-wide text-gray-500 dark:text-gray-400\">\r\n                  Zabelezeni dnevi\r\n                </p>\r\n                <p className=\"mt-2 text-2xl font-semibold text-gray-900 dark:text-gray-100\">\r\n                  {loggedDays !== null ? loggedDays : 'Nalaganje...'}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </section>\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n"],"names":["useState","useEffect","jsxs","jsx"],"mappings":"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"}